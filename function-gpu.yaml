metadata:
  name: pth-mis-yolorgb-gpu
  namespace: cvat
  annotations:
    name: YOLO RGB GPU
    type: detector
    spec: |
      [
        {"id": 0, "name": "TM-62P", "type": "rectangle"},
        {"id": 1, "name": "T-72", "type": "rectangle"},
        {"id": 2, "name": "PFM-1", "type": "rectangle"},
        {"id": 3, "name": "PTM-3", "type": "rectangle"},
        {"id": 4, "name": "POM-2", "type": "rectangle"},
        {"id": 5, "name": "PMN-4", "type": "rectangle"},
        {"id": 6, "name": "PMN-2", "type": "rectangle"},
        {"id": 7, "name": "PMN-1", "type": "rectangle"},
        {"id": 8, "name": "OZM-72", "type": "rectangle"},
        {"id": 9, "name": "MMG-82", "type": "rectangle"},
        {"id": 10, "name": "VOG-25", "type": "rectangle"},
        {"id": 11, "name": "TS-50", "type": "rectangle"},
        {"id": 12, "name": "TS-6.1", "type": "rectangle"},
        {"id": 48, "name": "TM-62M", "type": "rectangle"},
        {"id": 49, "name": "Dump_big", "type": "rectangle"},
        {"id": 50, "name": "Dump_small", "type": "rectangle"},
        {"id": 51, "name": "Dump_metal", "type": "rectangle"},
        {"id": 52, "name": "MON-50", "type": "rectangle"}
      ]

spec:
  description: YOLO RGB GPU
  runtime: 'python:3.10'
  handler: main:handler
  eventTimeout: 300s
  resources:
    limits:
      nvidia.com/gpu: 1

  build:
    image: cvat.pth.mis.yolorgb.gpu
    baseImage: python:3.10-slim

    directives:
      preCopy:
        - kind: RUN
          value: apt update && apt install -y python3-pip wget libgl1 libglib2.0-0 libsm6 libxext6 libxrender1
        - kind: RUN
          value: pip install opencv-python-headless pillow pyyaml ultralytics sahi
        - kind: WORKDIR
          value: /opt/nuclio
        - kind: RUN
          value: wget https://github.com/YurkevichAndrei/testyolo/releases/download/1/yolo_rgb_weights.pt
        - kind: RUN
          value: ln -s /usr/bin/python3 /usr/bin/python

  triggers:
    myHttpTrigger:
      numWorkers: 4
      kind: 'http'
      workerAvailabilityTimeoutMilliseconds: 300000
      attributes:
        maxRequestBodySize: 2147483647 # 2048MB
        port: 30050
        readTimeout: 300000
        writeTimeout: 300000

  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
      mountMode: volume
